---
// BaseLayout.astro
import '../styles/global.css';
const { title = "Regalo para mi amor 💖" } = Astro.props;
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>{title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  </head>
  <body>
    <div class="petal-layer" aria-hidden="true"></div>

    <div class="layout-container">
      <header class="layout-header">
        {Astro.url.pathname !== import.meta.env.BASE_URL && (
          <a href="javascript:history.back()" class="volver-btn">Atrás</a>
        )}
        <button id="modo-toggle">🌙 / ☀️</button>
      </header>

      <main>
        <slot />
      </main>

      <footer class="footer-banner">
        Hecho con mucho cariño para mi chica mexicana 🇲🇽🖤
      </footer>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Modo oscuro
        const toggle = document.getElementById('modo-toggle');
        const isDark = localStorage.getItem('modoOscuro') === 'true';
        if (isDark) document.body.classList.add('dark');

        toggle?.addEventListener('click', () => {
          document.body.classList.toggle('dark');
          localStorage.setItem('modoOscuro', document.body.classList.contains('dark'));
        });

        // Pétalos
        const layer = document.querySelector('.petal-layer');
        layer.innerHTML = '';
        for (let i = 0; i < 20; i++) {
          const petal = document.createElement('div');
          petal.className = 'petal';
          const petalTypes = ['🌸', '🌺', '💮'];
          petal.textContent = petalTypes[Math.floor(Math.random() * petalTypes.length)];
          petal.style.left = `${Math.random() * 100}vw`;
          petal.style.animationDelay = `${Math.random() * 5}s`;
          layer.appendChild(petal);
        }

        // Música
        const currentPath = window.location.pathname.replace(import.meta.env.BASE_URL, '/');
        const existingAudio = document.getElementById('bgMusic');

        if (currentPath === '/' || currentPath === '/secreto') {
          if (existingAudio) {
            let volume = existingAudio.volume;
            const fadeOut = setInterval(() => {
              if (volume > 0) {
                volume -= 0.05;
                existingAudio.volume = Math.max(volume, 0);
              } else {
                clearInterval(fadeOut);
                existingAudio.pause();
                existingAudio.remove();
                localStorage.removeItem('audioStarted');
              }
            }, 200);
          }
        } else {
          if (!existingAudio && !localStorage.getItem('audioStarted')) {
            const audio = document.createElement('audio');
            audio.id = 'bgMusic';
            audio.src = '/cancion.mp3';
            audio.loop = true;
            audio.autoplay = true;
            audio.volume = 0;
            audio.style.position = 'fixed';
            audio.style.bottom = '0';
            audio.style.left = '0';
            audio.style.opacity = '0';
            audio.style.pointerEvents = 'none';
            document.body.appendChild(audio);

            let volume = 0;
            const fadeIn = setInterval(() => {
              if (volume < 0.6) {
                volume += 0.05;
                audio.volume = Math.min(volume, 0.6);
              } else {
                clearInterval(fadeIn);
              }
            }, 200);

            localStorage.setItem('audioStarted', 'true');
          }
        }

        // ✅ Transición entre vistas
        window.fadeAndGo = function (url) {
          const page = document.querySelector('.page-transition');
          if (page) {
            page.classList.add('fade-out');
            setTimeout(() => {
              window.location.href = url;
            }, 600);
          } else {
            window.location.href = url;
          }
        };
      });
    </script>

  </body>
</html>
